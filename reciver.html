<!DOCTYPE html>
<html lang="en">
<head>
    <title>Receiver</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h2>Receive a File</h2>
    <p id="status">Waiting for file...</p>
    <progress id="progressBar" value="0" max="100"></progress>

    <script>
        const socket = io("https://file-transfer-mfru.onrender.com/", { transports: ["websocket"] });

        // const peerConnection = new RTCPeerConnection();
        const peerConnection = new RTCPeerConnection({
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { 
            urls: "turn:relay1.expressturn.com:3478", 
            username: "expressturn", 
            credential: "somepassword"
        }
    ]
});

        let dataChannel;
        let receivedChunks = [];
        let receivedSize = 0;
        let totalFileSize = 0;

        peerConnection.ondatachannel = (event) => {
            dataChannel = event.channel;
            
            dataChannel.onopen = () => {
                console.log("âœ… Data channel is open on Receiver!");
                document.getElementById("status").innerText = "Receiving file...";
            };

            dataChannel.onmessage = (event) => {
                if (typeof event.data === "string" && event.data === "EOF") {
                    const blob = new Blob(receivedChunks);
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "received_file";
                    link.click();
                    console.log("âœ… File received and saved!");
                    document.getElementById("status").innerText = "File received!";
                    return;
                }

                if (typeof event.data === "string") {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === "file-info") {
                            totalFileSize = message.size;
                            console.log(`â„¹ Receiving file of size: ${totalFileSize} bytes`);
                        }
                    } catch (e) {
                        console.error("Error parsing message:", e);
                    }
                    return;
                }

                receivedChunks.push(event.data);
                receivedSize += event.data.byteLength;

                // ðŸ”¹ Show progress
                const progress = ((receivedSize / totalFileSize) * 100).toFixed(2);
                document.getElementById("progressBar").value = progress;
                console.log(`ðŸ“¥ Receiving progress: ${progress}%`);
            };
        };

        // ðŸ”¹ Handle offer from sender
        // socket.on("offer", async (data) => {
        //     await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
        //     const answer = await peerConnection.createAnswer();
        //     await peerConnection.setLocalDescription(answer);
        //     socket.emit("answer", answer);
        // });




        socket.on("offer", async (data) => {
                    if (peerConnection.signalingState !== "stable") {
                        console.warn("âš  Ignoring offer because the connection is not stable.");
                        return;
                    }
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit("answer", answer);
                });


        // ðŸ”¹ Add ICE candidates
        socket.on("candidate", (candidate) => {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        });

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit("candidate", event.candidate);
            }
        };
    </script>
</body>
</html>
